<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SigniFi - Hand Gesture Recognition</title>
  <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar placeholder -->
  <div id="container"></div>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <h2 class="text-2xl font-bold text-gray-800">Hand Gesture Recognition</h2>
    <p class="text-gray-500 mt-2">Real-time hand gesture detection using basic computer vision.</p>
  
    <div class="mt-6 bg-white rounded-xl shadow-md p-6 space-y-6">
      <!-- Camera Section -->
      <div>
        <h3 class="text-lg font-semibold mb-3">Camera Preview</h3>
        <div class="relative">
          <video id="camera" autoplay playsinline muted class="w-full max-w-2xl rounded-lg shadow-md bg-black transform scale-x-[-1]"></video>
          <canvas id="overlay" class="absolute top-0 left-0 w-full max-w-2xl rounded-lg pointer-events-none"></canvas>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex gap-3 flex-wrap">
        <button id="startCameraBtn" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800">Start Camera</button>
        <button id="stopCameraBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 opacity-50 cursor-not-allowed" disabled>Stop Camera</button>
        <button id="captureBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 opacity-50 cursor-not-allowed" disabled>Capture Frame</button>
      </div>

      <!-- Status -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-semibold mb-2">Status</h4>
        <div id="statusInfo" class="text-sm text-gray-600">Click "Start Camera" to begin</div>
      </div>

      <!-- Captured Frame -->
      <div id="captureSection" class="hidden">
        <h3 class="text-lg font-semibold mb-3">Captured Frame</h3>
        <canvas id="snapshot" class="w-full max-w-lg rounded-lg shadow border"></canvas>
      </div>

      <!-- Simple Hand Detection Info -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold mb-2">Camera Info</h4>
          <div id="cameraInfo" class="text-sm text-gray-600">Camera not started</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold mb-2">Frame Rate</h4>
          <div id="fpsInfo" class="text-sm text-gray-600">0 FPS</div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    // Global variables
    let stream = null;
    let isRunning = false;
    let animationFrame = null;
    let lastFrameTime = 0;
    let frameCount = 0;
    let fps = 0;
    
    const video = document.getElementById('camera');
    const overlay = document.getElementById('overlay');
    const overlayCtx = overlay.getContext('2d');
    const snapshot = document.getElementById('snapshot');
    const snapshotCtx = snapshot.getContext('2d');
    
    const startBtn = document.getElementById('startCameraBtn');
    const stopBtn = document.getElementById('stopCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    
    const statusInfo = document.getElementById('statusInfo');
    const cameraInfo = document.getElementById('cameraInfo');
    const fpsInfo = document.getElementById('fpsInfo');
    const captureSection = document.getElementById('captureSection');

    // Update status
    function updateStatus(message) {
      statusInfo.textContent = message;
      console.log('Status:', message);
    }

    // Calculate FPS
    function calculateFPS() {
      const now = performance.now();
      frameCount++;
      
      if (now - lastFrameTime >= 1000) {
        fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
        fpsInfo.textContent = `${fps} FPS`;
        frameCount = 0;
        lastFrameTime = now;
      }
    }

    // Process video frame
    function processFrame() {
      if (!isRunning || !video.videoWidth || !video.videoHeight) {
        return;
      }

      // Update overlay canvas size to match video
      if (overlay.width !== video.videoWidth || overlay.height !== video.videoHeight) {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
      }

      // Clear overlay
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

      // Draw frame info
      overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      overlayCtx.fillRect(10, 10, 200, 80);
      
      overlayCtx.fillStyle = 'white';
      overlayCtx.font = '14px Arial';
      overlayCtx.fillText(`Resolution: ${video.videoWidth}x${video.videoHeight}`, 15, 30);
      overlayCtx.fillText(`FPS: ${fps}`, 15, 50);
      overlayCtx.fillText('Hand detection: Basic', 15, 70);

      // Simple motion detection (basic example)
      drawSimpleOverlay();

      calculateFPS();
      
      if (isRunning) {
        animationFrame = requestAnimationFrame(processFrame);
      }
    }

    // Draw simple overlay graphics
    function drawSimpleOverlay() {
      const centerX = overlay.width / 2;
      const centerY = overlay.height / 2;

      // Draw center crosshair
      overlayCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      overlayCtx.lineWidth = 2;
      overlayCtx.beginPath();
      overlayCtx.moveTo(centerX - 20, centerY);
      overlayCtx.lineTo(centerX + 20, centerY);
      overlayCtx.moveTo(centerX, centerY - 20);
      overlayCtx.lineTo(centerX, centerY + 20);
      overlayCtx.stroke();

      // Draw detection zone
      overlayCtx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
      overlayCtx.lineWidth = 2;
      overlayCtx.strokeRect(centerX - 150, centerY - 100, 300, 200);
      
      overlayCtx.fillStyle = 'rgba(0, 255, 0, 0.2)';
      overlayCtx.font = '12px Arial';
      overlayCtx.fillText('Hand Detection Zone', centerX - 60, centerY - 110);
    }

    // Start camera
    async function startCamera() {
      try {
        updateStatus('Requesting camera permission...');
        
        // Request camera access
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          } 
        });
        
        updateStatus('Camera permission granted. Starting video...');
        
        video.srcObject = stream;
        
        // Wait for video to load
        video.addEventListener('loadedmetadata', () => {
          updateStatus('Video loaded. Starting processing...');
          cameraInfo.textContent = `${video.videoWidth}x${video.videoHeight}`;
          
          isRunning = true;
          lastFrameTime = performance.now();
          processFrame();
          
          // Update button states
          startBtn.disabled = true;
          startBtn.classList.add('opacity-50', 'cursor-not-allowed');
          stopBtn.disabled = false;
          stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          captureBtn.disabled = false;
          captureBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          
          updateStatus('Camera is running. Hand detection active.');
        });

        video.addEventListener('error', (e) => {
          console.error('Video error:', e);
          updateStatus('Video error occurred');
        });
        
      } catch (err) {
        console.error('Error accessing camera:', err);
        
        let errorMessage = 'Could not access camera. ';
        if (err.name === 'NotAllowedError') {
          errorMessage += 'Permission denied. Please allow camera access and try again.';
        } else if (err.name === 'NotFoundError') {
          errorMessage += 'No camera found.';
        } else if (err.name === 'NotSupportedError') {
          errorMessage += 'Camera not supported in this browser.';
        } else {
          errorMessage += err.message || 'Unknown error.';
        }
        
        updateStatus(errorMessage);
        alert(errorMessage);
      }
    }

    // Stop camera
    function stopCamera() {
      isRunning = false;
      
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
      }
      
      if (stream) {
        stream.getTracks().forEach(track => {
          track.stop();
          console.log('Stopped track:', track.kind);
        });
        stream = null;
      }
      
      video.srcObject = null;
      
      // Clear overlays
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      
      // Reset button states
      startBtn.disabled = false;
      startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      stopBtn.disabled = true;
      stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
      captureBtn.disabled = true;
      captureBtn.classList.add('opacity-50', 'cursor-not-allowed');
      
      // Reset info
      updateStatus('Camera stopped');
      cameraInfo.textContent = 'Camera not running';
      fpsInfo.textContent = '0 FPS';
      fps = 0;
      frameCount = 0;
    }

    // Capture frame
    function captureFrame() {
      if (!isRunning || !video.videoWidth || !video.videoHeight) {
        return;
      }

      snapshot.width = video.videoWidth;
      snapshot.height = video.videoHeight;
      
      // Draw video frame to snapshot canvas (mirrored)
      snapshotCtx.save();
      snapshotCtx.scale(-1, 1);
      snapshotCtx.translate(-snapshot.width, 0);
      snapshotCtx.drawImage(video, 0, 0);
      snapshotCtx.restore();
      
      // Show capture section
      captureSection.classList.remove('hidden');
      
      updateStatus('Frame captured!');
      
      // Scroll to captured frame
      captureSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Event listeners
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', captureFrame);

    // Check for getUserMedia support
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      updateStatus('getUserMedia is not supported in this browser');
      startBtn.disabled = true;
      startBtn.textContent = 'Camera Not Supported';
    } else {
      updateStatus('Ready to start camera');
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (isRunning) {
        stopCamera();
      }
    });

    // Handle visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isRunning) {
        console.log('Page hidden, pausing processing');
        isRunning = false;
      } else if (!document.hidden && stream) {
        console.log('Page visible, resuming processing');
        isRunning = true;
        processFrame();
      }
    });
  </script>
  <script src="../pages/scripts/sidebar.js"></script>
</body>
</html>